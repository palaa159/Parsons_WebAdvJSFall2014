function VectorEditor(t,e,s){function i(){if(window.Ext)return Ext.get(t).getXY();if(window.jQuery){var e=jQuery(t).offset();return[e.left,e.top]}if(window.vx){var e=vx.pos(t);return[e.l,e.t]}return[0,0]}function o(t,e){return function(){return t.apply(e,h(arguments))}}function h(t){for(var e=t.length,s=[];e--;)s.push(t[e]);return s}if("function"!=typeof Raphael)return alert("Error! Renderer is Missing!");this.container=t,this.draw=Raphael(t,e,s),this.draw.editor=this,this.onHitXY=[0,0],this.offsetXY=[0,0],this.tmpXY=[0,0],this.prop={src:"1.png","stroke-width":1,stroke:"#000000",fill:"#ff0000","stroke-opacity":1,"fill-opacity":1,text:"Text"},this.mode="select",this.selectbox=null,this.selected=[],this.action="",this.selectadd=!1,this.shapes=[],this.trackers=[],this.listeners={};this.draw;window.Ext?(Ext.get(t).on("mousedown",function(t){return t.preventDefault(),2==t.button&&this.setMode("select"),1!=t.button?(this.onMouseDown(t.getPageX()-i()[0],t.getPageY()-i()[1],t.getTarget()),!1):void 0},this),Ext.get(t).on("mousemove",function(t){return t.preventDefault(),this.onMouseMove(t.getPageX()-i()[0],t.getPageY()-i()[1],t.getTarget()),!1},this),Ext.get(t).on("mouseup",function(t){return t.preventDefault(),this.onMouseUp(t.getPageX()-i()[0],t.getPageY()-i()[1],t.getTarget()),!1},this),Ext.get(t).on("dblclick",function(t){return t.preventDefault(),this.onDblClick(t.getPageX()-i()[0],t.getPageY()-i()[1],t.getTarget()),!1},this)):window.jQuery&&($(t).mousedown(o(function(t){t.preventDefault(),2==t.button&&this.setMode("select"),this.onMouseDown(t.clientX-i()[0],t.clientY-i()[1],t.target)},this)),$(t).mousemove(o(function(t){t.preventDefault(),this.onMouseMove(t.clientX-i()[0],t.clientY-i()[1],t.target)},this)),$(t).mouseup(o(function(t){t.preventDefault(),this.onMouseUp(t.clientX-i()[0],t.clientY-i()[1],t.target)},this)),$(t).dblclick(o(function(t){t.preventDefault(),this.onDblClick(t.clientX-i()[0],t.clientY-i()[1],t.target)},this)),mobilesafari&&(t.addEventListener("touchstart",o(function(t){t.preventDefault(),this.onMouseDown(t.touches[0].pageX-i()[0],t.touches[0].pageY-i()[1],t.target)},this),!1),t.addEventListener("touchmove",o(function(t){t.preventDefault(),this.onMouseMove(t.touches[0].pageX-i()[0],t.touches[0].pageY-i()[1],t.target)},this),!1),t.addEventListener("touchend",o(function(t){t.preventDefault(),this.onMouseUp(0,0,t.target)},this),!1),t.addEventListener("selectstart",function(t){return t.preventDefault(),!1},!1)))}var mobilesafari=/AppleWebKit.*Mobile/.test(navigator.userAgent);VectorEditor.prototype.setMode=function(t){this.fire("setmode",t),"select+"==t?(this.mode="select",this.selectadd=!0,this.unselect()):"select"==t?(this.mode=t,this.unselect(),this.selectadd=!1):"delete"==t?(this.deleteSelection(),this.mode=t):(this.unselect(),this.mode=t)},VectorEditor.prototype.on=function(t,e){this.listeners[t]||(this.listeners[t]=[]),-1==this.in_array(e,this.listeners[t])&&this.listeners[t].push(e)},VectorEditor.prototype.returnRotatedPoint=function(t,e,s,i,o){var h=Math.sqrt((t-s)*(t-s)+(e-i)*(e-i)),r=Math.atan2(e-i,t-s)*(180/Math.PI),n=h*Math.cos((o+r)/(180/Math.PI)),a=h*Math.sin((o+r)/(180/Math.PI));return[s+n,i+a]},VectorEditor.prototype.fire=function(t){if(this.listeners[t])for(var e=0;e<this.listeners[t].length;e++)if(this.listeners[t][e].apply(this,arguments)===!1)return!1},VectorEditor.prototype.un=function(t,e){if(this.listeners[t])for(var s=0;-1!=(s=this.in_array(e,this.listeners[t]));)this.listeners[t].splice(s,1)},VectorEditor.prototype.in_array=function(t,e){for(var s=e.length;s--&&e[s]!=t;);return s},VectorEditor.prototype.array_remove=function(t,e){var s=this.in_array(t,e);-1!=s?e.splice(s,1):0},VectorEditor.prototype.is_selected=function(t){return-1!=this.in_array(t,this.selected)},VectorEditor.prototype.set_attr=function(){for(var t=0;t<this.selected.length;t++)this.selected[t].attr.apply(this.selected[t],arguments)},VectorEditor.prototype.set=function(t,e){this.prop[t]=e,this.set_attr(t,e)},VectorEditor.prototype.onMouseDown=function(t,e,s){if(this.fire("mousedown"),this.tmpXY=this.onHitXY=[t,e],"select"!=this.mode||this.selectbox)if("delete"!=this.mode||this.selectbox){if(0==this.selected.length){var i=null;"rect"==this.mode?i=this.draw.rect(t,e,0,0):"image"==this.mode?i=this.draw.image(this.prop.src,t,e,0,0):"text"==this.mode&&(i=this.draw.text(t,e,this.prop.text).attr("font-size",0),i.text=this.prop.text),i&&(i.id=this.generateUUID(),i.attr({fill:this.prop.fill,stroke:this.prop.stroke,"stroke-width":this.prop["stroke-width"],"fill-opacity":this.prop["fill-opacity"],"stroke-opacity":this.prop["stroke-opacity"]}),this.addShape(i))}}else{var o=null;if(s.shape_object)o=s.shape_object;else{if(!s.parentNode.shape_object)return s.is_tracker?void 0:(this.selectbox=this.draw.rect(t,e,0,0).attr({"fill-opacity":.15,"stroke-opacity":.5,fill:"#ff0000",stroke:"#ff0000"}),void 0);o=s.parentNode.shape_object}this.deleteShape(o),this.offsetXY=[o.attr("x")-t,o.attr("y")-e]}else{var o=null;if(s.shape_object)o=s.shape_object;else{if(!s.parentNode.shape_object)return s.is_tracker?void 0:(this.selectadd||this.unselect(),this.selectbox=this.draw.rect(t,e,0,0).attr({"fill-opacity":.15,"stroke-opacity":.5,fill:"#007fff",stroke:"#007fff"}),void 0);o=s.parentNode.shape_object}this.selectadd?(this.selectAdd(o),this.action="move"):this.is_selected(o)?this.action="move":(this.select(o),this.action="move"),this.offsetXY=[o.attr("x")-t,o.attr("y")-e]}return!1},VectorEditor.prototype.onMouseMove=function(t,e){if(this.fire("mousemove"),"select"==this.mode||"delete"==this.mode){if(this.selectbox)this.resize(this.selectbox,t-this.onHitXY[0],e-this.onHitXY[1],this.onHitXY[0],this.onHitXY[1]);else if("select"==this.mode)if("move"==this.action){for(var s=0;s<this.selected.length;s++)this.move(this.selected[s],t-this.tmpXY[0],e-this.tmpXY[1]);this.updateTracker(),this.tmpXY=[t,e]}else if("rotate"==this.action){var i=this.selected[0].getBBox(),o=Math.atan2(e-(i.y+i.height/2),t-(i.x+i.width/2)),h=((o*(180/Math.PI)+90)%360+360)%360;this.selected[0].rotate(h,!0),this.updateTracker()}else if("path"==this.action.substr(0,4)){var r=parseInt(this.action.substr(4)),n=Raphael.parsePathString(this.selected[0].attr("path"));n[r]&&(n[r][1]=t,n[r][2]=e,this.selected[0].attr("path",n),this.updateTracker())}else if("resize"==this.action){this.onGrabXY||(this.onGrabXY="ellipse"==this.selected[0].type?[this.selected[0].attr("cx"),this.selected[0].attr("cy")]:"path"==this.selected[0].type?[this.selected[0].getBBox().x,this.selected[0].getBBox().y,this.selected[0].getBBox().width,this.selected[0].getBBox().height]:[this.selected[0].attr("x"),this.selected[0].attr("y")]);var i=this.selected[0].getBBox(),a=this.returnRotatedPoint(t,e,i.x+i.width/2,i.y+i.height/2,-this.selected[0].attr("rotation"));t=a[0]-5,e=a[1]-5,"rect"==this.selected[0].type?this.resize(this.selected[0],t-this.onGrabXY[0],e-this.onGrabXY[1],this.onGrabXY[0],this.onGrabXY[1]):"image"==this.selected[0].type?this.resize(this.selected[0],t-this.onGrabXY[0],e-this.onGrabXY[1],this.onGrabXY[0],this.onGrabXY[1]):"text"==this.selected[0].type?this.resize(this.selected[0],t-this.onGrabXY[0],e-this.onGrabXY[1],this.onGrabXY[0],this.onGrabXY[1]):"path"==this.selected[0].type&&this.selected[0].scale((t-this.onGrabXY[0])/this.onGrabXY[2],(e-this.onGrabXY[1])/this.onGrabXY[3],this.onGrabXY[0],this.onGrabXY[1]),this.newTracker(this.selected[0])}}else if(1==this.selected.length)if("rect"==this.mode)this.resize(this.selected[0],t-this.onHitXY[0],e-this.onHitXY[1],this.onHitXY[0],this.onHitXY[1]);else if("image"==this.mode)this.resize(this.selected[0],t-this.onHitXY[0],e-this.onHitXY[1],this.onHitXY[0],this.onHitXY[1]);else if("text"==this.mode)this.resize(this.selected[0],t-this.onHitXY[0],e-this.onHitXY[1],this.onHitXY[0],this.onHitXY[1]);else if("path"==this.mode)this.selected[0].attr("path",this.selected[0].attrs.path+"L"+t+" "+e);else if("polygon"==this.mode||"line"==this.mode){var n=Raphael.parsePathString(this.selected[0].attr("path"));if(n.length>1){if("line"==this.mode)n.splice(1);else{{n[n.length-1]}this.selected[0].polypoints.length<n.length&&n.splice(n.length-1,1)}this.selected[0].attr("path",n.toString()+"L"+t+" "+e)}else this.selected[0].attr("path",this.selected[0].attrs.path+"L"+t+" "+e)}return!1},VectorEditor.prototype.getMarkup=function(){return this.draw.canvas.parentNode.innerHTML},VectorEditor.prototype.onMouseUp=function(){if(this.fire("mouseup"),this.onGrabXY=null,"select"==this.mode||"delete"==this.mode)if(this.selectbox){for(var t=this.selectbox.getBBox(),e=[],s=0;s<this.shapes.length;s++)this.rectsIntersect(this.shapes[s].getBBox(),t)&&e.push(this.shapes[s]);if((0==e.length||0==this.selectadd)&&this.unselect(),1==e.length&&0==this.selectadd)this.select(e[0]);else for(var s=0;s<e.length;s++)this.selectAdd(e[s]);this.selectbox.node.parentNode&&this.selectbox.remove(),this.selectbox=null,"delete"==this.mode&&this.deleteSelection()}else this.action="";else 1==this.selected.length&&(0==this.selected[0].getBBox().height&&0==this.selected[0].getBBox().width&&"polygon"!=this.selected[0].subtype&&this.deleteShape(this.selected[0]),"rect"==this.mode?this.unselect():"line"==this.mode?this.unselect():"image"==this.mode?this.unselect():"text"==this.mode&&this.unselect());return this.lastmode&&(this.setMode(this.lastmode),delete this.lastmode),!1};